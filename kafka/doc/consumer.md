# 消费者

- [消费者](#消费者)
  - [1. 消费者相关概念](#1-消费者相关概念)
    - [1.1. 消费者和消费者组](#11-消费者和消费者组)
    - [1.2. 分区再平衡](#12-分区再平衡)
      - [1.2.1. 主动再平衡](#121-主动再平衡)
      - [1.2.2. 协作再平衡](#122-协作再平衡)

## 1. 消费者相关概念

**消费者** (Consumer) 即从 Kafka 读取消息的角色, 即生产者向 Kafka 写入消息, 由消费者从 Kafka 读取消息

### 1.1. 消费者和消费者组

Kafka 消费者从属于 **消费者组** (Consumer Group), 一个群组里的消费者订阅的是同一个主题的消息, 且主题的每个分区会分配给唯一的一个消费者. 即: 每个分区只能有一个消费者消费 (不可能将一个分区交给多个消费者), 但一个消费者可以同时消费多个分区

一般来说, 消费要比生产的速度慢, 所以消费者群组是对消费者进行横向扩展的方法

假设主题 `T1` 包含四个分区: `分区0 ~ 分区3`, 一个消费者组 `G1`, 则 `G1` 包含不同数量的消费者情况为:

1. 单消费者

   ![*](./../assets/consumer-group-one-consumer.png)

   此时, 单独的一个消费者会消费主题中所有分区的消息

2. 多消费者

   ![*](./../assets/consumer-group-two-consumer.png)

   此时, 四个分区会均匀的分配给两个消费者, 其中 `C1` 消费 `分区0` 和 `分区2`, `C2` 消费 `分区1` 和 `分区3`

3. 每个分区一个消费者

   ![*](./../assets/consumer-group-four-consumer.png)

   如果能为每个分区配备一个消费者, 则可以达到最佳的吞吐量

4. 消费者多于分区

   ![*](./../assets/consumer-group-five-consumer.png)

   如果消费者的数量多于分区的数量, 则多余的消费者将无法收到任何分区的消息, 因为一个分区不得被多个消费者消费, 所以设置多余分区数量的消费者是无意义的

可以增加多个消费者组, 例如为上面的例子增加消费者组 `G2` 也订阅主题 `T1` 的消息, 则 `G1` 和 `G2` 都会收到主题 `T1` 的全部消息, 即:

![*](../assets/multi-consumer-group.png)

增加消费者组和消费者, 不会影响 Kafka 的性能

### 1.2. 分区再平衡

分区再平衡 (Rebalance) 指的是当一个主题相关的消费者群组中的消费者发生变化时 (加入新的消费者或关闭已有的消费者), 则分区会进行 **再平衡**

消费者会向被指定为群组协调器的 Broker (不同消费者群组的协调器可能不同) 发送心跳, 以此来保持群组成员关系和对分区的所有权关系

心跳是由消费者的一个后台线程发送的, 只要消费者能够以正常的时间间隔发送心跳, Kafka 集群就会认为该消费者还"存活"; 如果消费者在足够长的一段时间内没有发送心跳, 群组协调器会认为它已经"死亡", 进而触发再平衡

在消费者被判定为"死亡"的这几秒时间里, "死亡"的消费者不会读取分区里的消息, 在关闭消费者后, 协调器会立即触发一次再平衡, 尽量降低处理延迟

根据消费者群组所使用的分区分配策略的不同, 分区再平衡分为两种情况

#### 1.2.1. 主动再平衡

在进行主动再平衡期间, 所有消费者都会停止读取消息, 放弃分区所有权并重新加入消费者群组, 并获得重新分配到的分区

主动再平衡会导致整个消费者群组在一个很短的时间窗口内不可用, 这个时间窗口的长短取决于消费者群组的大小和几个配置参数

![*](./../assets/active-rebalance.png)

可以看到, 主动再平衡包含两个不同的阶段:

- 第一个阶段, 所有消费者都放弃分区所有权;
- 第二个阶段, 消费者重新加入群组, 获得重新分配到的分区, 并继续读取消息;

#### 1.2.2. 协作再平衡

协作再平衡, 也称为增量再平衡, 通常是指将一个消费者的部分分区重新分配给另一个消费者，其他消费者则继续读取没有被重新分配的分区

这种再平衡包含两个或多个阶段:

- 在第一个阶段, 消费者群组首领会通知所有消费者, 它们将失去部分分区的所有权, 然后消费者会停止读取这些分区, 并放弃对它们的所有权;
- 在第二个阶段, 消费者群组首领会将这些没有所有权的分区分配给其他消费者;

虽然这种增量再平衡可能需要进行几次迭代, 直到达到稳定状态, 但它避免了主动再平衡中出现的停顿窗口期, 这对大型消费者群组来说尤为重要, 因为它们的再平衡可能需要很长时间

![*](../assets/cooperation-rebalance.png)

